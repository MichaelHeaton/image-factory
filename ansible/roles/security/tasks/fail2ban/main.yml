---
# Fail2ban configuration for brute force protection

- name: Install fail2ban
  ansible.builtin.apt:
    name: fail2ban
    state: present

- name: Configure fail2ban defaults
  ansible.builtin.copy:
    dest: /etc/fail2ban/jail.local
    content: |
      [DEFAULT]
      # Ban hosts for 1 hour
      bantime = 3600
      # Time window for failures
      findtime = 600
      # Number of failures before ban
      maxretry = 5
      # Backend to use
      backend = systemd
      # Email notifications (disabled by default)
      destemail = root@localhost
      sendername = Fail2Ban
      action = %(action_)s

      [sshd]
      enabled = true
      port = ssh
      logpath = %(sshd_log)s
      backend = %(sshd_backend)s
      maxretry = 3
      findtime = 600
      bantime = 3600
    mode: "0644"
    owner: root
    group: root

- name: Enable and start fail2ban
  ansible.builtin.systemd:
    name: fail2ban
    enabled: true
    state: started
    daemon_reload: true

- name: Verify fail2ban is running
  ansible.builtin.command: fail2ban-client status
  register: fail2ban_status
  changed_when: false
  failed_when: false

- name: Display fail2ban status
  ansible.builtin.debug:
    var: fail2ban_status.stdout_lines
  when: fail2ban_status.rc == 0
