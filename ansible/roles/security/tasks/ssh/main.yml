---
- name: Backup SSH configuration
  ansible.builtin.copy:
    src: /etc/ssh/sshd_config
    dest: /etc/ssh/sshd_config.backup
    remote_src: true

- name: Check if SSH keys are configured for packer user
  ansible.builtin.stat:
    path: /home/packer/.ssh/authorized_keys
  register: packer_ssh_keys
  failed_when: false
  changed_when: false

- name: Check if SSH keys are configured for michael user
  ansible.builtin.stat:
    path: /home/michael/.ssh/authorized_keys
  register: michael_ssh_keys
  failed_when: false
  changed_when: false

- name: Determine if password auth should be enabled
  ansible.builtin.set_fact:
    enable_password_auth: "{{ not (packer_ssh_keys.stat.exists or michael_ssh_keys.stat.exists) }}"

- name: Warn if password auth will be enabled
  ansible.builtin.debug:
    msg: |
      WARNING: No SSH keys found for packer or michael users.
      Password authentication will be ENABLED for security reasons.
      This is less secure. Add SSH keys and rebuild the image to disable password auth.
  when: enable_password_auth | bool

- name: Configure SSH security settings
  ansible.builtin.blockinfile:
    path: /etc/ssh/sshd_config
    marker: "# {mark} ANSIBLE MANAGED BLOCK"
    block: |
      # Security hardening settings
      PermitRootLogin no
      PasswordAuthentication {{ 'yes' if enable_password_auth | bool else 'no' }}
      PubkeyAuthentication yes
      AuthorizedKeysFile .ssh/authorized_keys
      PermitEmptyPasswords no
      ChallengeResponseAuthentication no
      UsePAM yes
      X11Forwarding no
      MaxAuthTries 3
      MaxSessions 2
      ClientAliveInterval 300
      ClientAliveCountMax 2
      Compression no
      Protocol 2

      # Cipher and MAC algorithms
      Ciphers chacha20-poly1305@openssh.com,aes256-gcm@openssh.com,aes128-gcm@openssh.com,aes256-ctr,aes192-ctr,aes128-ctr
      MACs hmac-sha2-512-etm@openssh.com,hmac-sha2-256-etm@openssh.com,hmac-sha2-512,hmac-sha2-256
      KexAlgorithms curve25519-sha256@libssh.org,diffie-hellman-group-exchange-sha256
      HostKeyAlgorithms ssh-ed25519,ssh-ed25519-cert-v01@openssh.com,rsa-sha2-512,rsa-sha2-512-cert-v01@openssh.com

- name: Find SSH config files in sshd_config.d directory
  ansible.builtin.find:
    paths: /etc/ssh/sshd_config.d
    patterns: "*.conf"
  register: sshd_config_d_files
  failed_when: false
  changed_when: false

- name: Disable password authentication in sshd_config.d files
  ansible.builtin.replace:
    path: "{{ item.path }}"
    regexp: '^PasswordAuthentication\s+yes'
    replace: "PasswordAuthentication no"
  loop: "{{ sshd_config_d_files.files | default([]) }}"
  when:
    - packer_ssh_keys.stat.exists or michael_ssh_keys.stat.exists
    - sshd_config_d_files.files | default([]) | length > 0

- name: Ensure SSH service is enabled and running
  ansible.builtin.systemd:
    name: ssh
    enabled: true
    state: restarted
    daemon_reload: true

- name: Verify SSH is listening on port 22
  ansible.builtin.wait_for:
    port: 22
    host: "{{ ansible_default_ipv4.address }}"
    delay: 2
    timeout: 10
  ignore_errors: true
