---
- name: Install auditd
  ansible.builtin.apt:
    name:
      - auditd
      - audispd-plugins
    state: present
    lock_timeout: 300

- name: Configure auditd rules
  ansible.builtin.copy:
    dest: /etc/audit/rules.d/99-hardening.rules
    content: |
      # Remove all existing rules
      -D

      # Buffer size
      -b 8192

      # Failure mode
      -f 1

      # Make the configuration immutable
      -e 2

      # Monitor file system mounts
      -a always,exit -F arch=b64 -S mount -S umount2 -F auid>=1000 -F auid!=4294967295 -k mounts
      -a always,exit -F arch=b32 -S mount -S umount2 -F auid>=1000 -F auid!=4294967295 -k mounts

      # Monitor file deletions
      -a always,exit -F arch=b64 -S unlink -S unlinkat -S rename -S renameat -F auid>=1000 -F auid!=4294967295 -k delete
      -a always,exit -F arch=b32 -S unlink -S unlinkat -S rename -S renameat -F auid>=1000 -F auid!=4294967295 -k delete

      # Monitor privilege escalation
      -w /etc/sudoers -p wa -k privileged
      -w /etc/sudoers.d/ -p wa -k privileged
      -w /usr/bin/sudo -p x -k privileged
      -w /usr/bin/su -p x -k privileged

      # Monitor user/group changes
      -w /etc/group -p wa -k identity
      -w /etc/passwd -p wa -k identity
      -w /etc/gshadow -p wa -k identity
      -w /etc/shadow -p wa -k identity
      -w /etc/security/opasswd -p wa -k identity

      # Monitor network configuration
      -w /etc/network/ -p wa -k network
      -w /etc/hosts -p wa -k network
      -w /etc/hostname -p wa -k network

      # Monitor system configuration
      -w /etc/crontab -p wa -k cron
      -w /etc/cron.d/ -p wa -k cron
      -w /etc/cron.hourly/ -p wa -k cron
      -w /etc/cron.daily/ -p wa -k cron
      -w /etc/cron.weekly/ -p wa -k cron
      -w /etc/cron.monthly/ -p wa -k cron

      # Monitor login/logout
      -w /var/log/faillog -p wa -k logins
      -w /var/log/lastlog -p wa -k logins
      -w /var/log/tallylog -p wa -k logins

      # Monitor session initiation
      -w /var/run/utmp -p wa -k session
      -w /var/log/wtmp -p wa -k session
      -w /var/log/btmp -p wa -k session

- name: Enable and start auditd
  ansible.builtin.systemd:
    name: auditd
    enabled: true
    state: started
    daemon_reload: true
