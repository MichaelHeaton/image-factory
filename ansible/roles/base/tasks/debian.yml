---
- name: Wait for apt lock to be released (if it exists)
  ansible.builtin.wait_for:
    path: /var/lib/apt/lists/lock
    state: absent
    timeout: 30
  failed_when: false
  changed_when: false

- name: Wait for dpkg lock to be released (if it exists)
  ansible.builtin.wait_for:
    path: /var/lib/dpkg/lock-frontend
    state: absent
    timeout: 30
  failed_when: false
  changed_when: false

- name: Update package lists
  ansible.builtin.apt:
    update_cache: yes
    cache_valid_time: 3600
    lock_timeout: 300

- name: Upgrade all packages
  ansible.builtin.apt:
    upgrade: dist
    update_cache: yes
    force_apt_get: true
    lock_timeout: 300
  ignore_errors: true

- name: Set base packages list
  ansible.builtin.set_fact:
    base_packages:
      - curl
      - wget
      - git
      - vim
      - tmux
      - ufw
      - unattended-upgrades
      - apt-transport-https
      - ca-certificates
      - gnupg
      - lsb-release
      - software-properties-common

- name: Add qemu-guest-agent to packages list for non-Pi systems
  ansible.builtin.set_fact:
    base_packages: "{{ base_packages + ['qemu-guest-agent'] }}"
  when: not (is_raspberry_pi | default(false))

- name: Install essential packages
  ansible.builtin.apt:
    name: "{{ base_packages }}"
    state: present
    lock_timeout: 300

- name: Enable and start qemu-guest-agent
  ansible.builtin.systemd:
    name: qemu-guest-agent
    enabled: true
    state: started
    daemon_reload: true
  when: not (is_raspberry_pi | default(false))

- name: Ensure SSH service is enabled and running
  ansible.builtin.systemd:
    name: ssh
    enabled: true
    state: started
    daemon_reload: true

- name: Get current hostname
  ansible.builtin.command: hostname
  register: current_hostname
  changed_when: false
  failed_when: false

- name: Set hostname if target_hostname is defined and different
  ansible.builtin.hostname:
    name: "{{ target_hostname }}"
  when: target_hostname is defined and current_hostname.stdout != target_hostname

- name: Update /etc/hosts with new hostname
  ansible.builtin.lineinfile:
    path: /etc/hosts
    regexp: '^127\.0\.1\.1\s+.*'
    line: "127.0.1.1\t{{ target_hostname }} {{ target_hostname }}.local"
    state: present
  when: target_hostname is defined

- name: Add swarm cluster nodes to /etc/hosts
  ansible.builtin.lineinfile:
    path: /etc/hosts
    regexp: '^{{ item.ansible_host }}\s+.*'
    line: "{{ item.ansible_host }}\t{{ item.target_hostname }}"
    state: present
  loop: "{{ groups['swarm'] | default([]) }}"
  when:
    - groups['swarm'] is defined
    - item.target_hostname is defined
    - item.ansible_host is defined
    - item.target_hostname != target_hostname | default('')
  loop_control:
    label: "{{ item.target_hostname }}"

- name: Detect primary network interface
  ansible.builtin.shell: |
    ip route | grep default | awk '{print $5}' | head -1 || echo "eth0"
  register: network_interface_result
  changed_when: false
  failed_when: false
  when: static_ip is defined

- name: Set network interface name
  ansible.builtin.set_fact:
    network_interface: "{{ network_interface_result.stdout | trim | default('eth0') }}"
  when: static_ip is defined

- name: Check if netplan configuration exists
  ansible.builtin.stat:
    path: /etc/netplan/00-installer-config.yaml
  register: netplan_config
  when: static_ip is defined

- name: Find all netplan files
  ansible.builtin.find:
    paths: /etc/netplan
    patterns: "*.yaml,*.yml"
  register: netplan_files_result
  when: static_ip is defined

- name: Backup and remove conflicting netplan files (cloud-init, etc.)
  ansible.builtin.file:
    path: "{{ item.path }}"
    state: absent
    backup: true
  loop: "{{ netplan_files_result.files | default([]) }}"
  when:
    - static_ip is defined
    - item.path != '/etc/netplan/00-installer-config.yaml'
  failed_when: false

- name: Configure static IP with netplan
  ansible.builtin.template:
    src: netplan-static.yaml.j2
    dest: /etc/netplan/00-installer-config.yaml
    mode: "0600"
    owner: root
    group: root
    backup: true
  when: static_ip is defined

- name: Apply netplan configuration
  ansible.builtin.command: netplan apply
  when: static_ip is defined
  register: netplan_apply_result
  changed_when: netplan_apply_result.rc == 0
  failed_when: false  # Don't fail if netplan apply has issues, we'll verify below

- name: Wait for network to stabilize after netplan apply
  ansible.builtin.pause:
    seconds: 3
  when: static_ip is defined

- name: Verify static IP is configured
  ansible.builtin.command: ip addr show {{ network_interface | default('eth0') }}
  register: ip_check
  changed_when: false
  when: static_ip is defined

- name: Display IP configuration
  ansible.builtin.debug:
    var: ip_check.stdout
  when: static_ip is defined

- name: Test network connectivity to gateway
  ansible.builtin.command: ping -c 2 -W 2 {{ network_gateway | default('172.16.15.1') }}
  register: gateway_ping
  changed_when: false
  failed_when: false
  when: static_ip is defined

- name: Warn if gateway is not reachable
  ansible.builtin.debug:
    msg: "WARNING: Gateway {{ network_gateway | default('172.16.15.1') }} is not reachable. This may indicate a network infrastructure issue. Check switch/VLAN configuration and firewall rules."
  when:
    - static_ip is defined
    - gateway_ping.rc != 0

- name: Set timezone to UTC
  ansible.builtin.timezone:
    name: UTC

- name: Enable and start systemd-timesyncd
  ansible.builtin.systemd:
    name: systemd-timesyncd
    enabled: true
    state: started
    daemon_reload: true

- name: Clean up unused packages
  ansible.builtin.apt:
    autoremove: true
    autoclean: true

