---
# NVME drive detection and configuration for Raspberry Pi 5

- name: Check for NVME devices
  ansible.builtin.shell: |
    ls -la /dev/nvme* 2>&1 || echo "No NVME devices found"
  register: nvme_devices
  changed_when: false
  failed_when: false

- name: Display NVME device check results
  ansible.builtin.debug:
    msg: "{{ nvme_devices.stdout_lines }}"

- name: Check dmesg for NVME detection
  ansible.builtin.shell: |
    dmesg | grep -i nvme | tail -20 || echo "No NVME messages in dmesg"
  register: nvme_dmesg
  changed_when: false
  failed_when: false

- name: Display NVME dmesg messages
  ansible.builtin.debug:
    msg: "{{ nvme_dmesg.stdout_lines }}"

- name: List all block devices
  ansible.builtin.command: lsblk -o NAME,SIZE,TYPE,MOUNTPOINT,FSTYPE,UUID
  register: block_devices
  changed_when: false
  failed_when: false

- name: Display all block devices
  ansible.builtin.debug:
    msg: "{{ block_devices.stdout_lines }}"

- name: Check if NVME is detected in lsblk
  ansible.builtin.shell: |
    lsblk | grep -i nvme || echo "No NVME devices in lsblk"
  register: nvme_lsblk
  changed_when: false
  failed_when: false

- name: Display NVME in lsblk
  ansible.builtin.debug:
    msg: "{{ nvme_lsblk.stdout_lines }}"

- name: Check PCI devices for NVME controller
  ansible.builtin.shell: |
    lspci | grep -i nvme || echo "No NVME controller in PCI"
  register: nvme_pci
  changed_when: false
  failed_when: false

- name: Display PCI NVME info
  ansible.builtin.debug:
    msg: "{{ nvme_pci.stdout_lines }}"

- name: Check if rpi-eeprom-update is installed
  ansible.builtin.command: which rpi-eeprom-update
  register: rpi_eeprom_check
  changed_when: false
  failed_when: false

- name: Install rpi-eeprom-update if not installed
  ansible.builtin.apt:
    name:
      - rpi-eeprom-update
      - raspi-config
    state: present
  when: rpi_eeprom_check.rc != 0

- name: Check current bootloader version
  ansible.builtin.command: rpi-eeprom-update
  register: bootloader_info
  changed_when: false
  failed_when: false
  ignore_errors: true

- name: Display bootloader information
  ansible.builtin.debug:
    msg: "{{ bootloader_info.stdout_lines }}"
  when: bootloader_info.rc == 0

- name: Check boot order configuration
  ansible.builtin.shell: |
    vcgencmd bootloader_config | grep -i boot_order || echo "Cannot read boot order"
  register: boot_order
  changed_when: false
  failed_when: false
  ignore_errors: true

- name: Display boot order
  ansible.builtin.debug:
    msg: "{{ boot_order.stdout_lines }}"
  when: boot_order.rc == 0

