---
# NVME drive fix and configuration tasks for Raspberry Pi 5

- name: Check if NVME kernel module is loaded
  ansible.builtin.shell: lsmod | grep nvme || echo "nvme module not loaded"
  register: nvme_module
  changed_when: false
  failed_when: false

- name: Load NVME kernel module if not loaded
  ansible.builtin.modprobe:
    name: nvme
    state: present
  when: "'nvme' not in nvme_module.stdout"

- name: Load NVME PCIe module if not loaded
  ansible.builtin.modprobe:
    name: nvme_core
    state: present
  when: "'nvme' not in nvme_module.stdout"

- name: Check PCIe bus status
  ansible.builtin.shell: |
    dmesg | grep "1000110000.pcie" | grep -E "(link up|link down)" | tail -1
  register: pcie_link_status
  changed_when: false
  failed_when: false

- name: Display PCIe link status
  ansible.builtin.debug:
    msg: "{{ pcie_link_status.stdout }}"

- name: Check for NVME devices after module load
  ansible.builtin.shell: |
    sleep 2
    ls -la /dev/nvme* 2>&1 || echo "No NVME devices"
  register: nvme_check_after_load
  changed_when: false
  failed_when: false

- name: Display NVME devices after module load
  ansible.builtin.debug:
    msg: "{{ nvme_check_after_load.stdout_lines }}"

- name: Rescan PCIe bus
  ansible.builtin.shell: |
    echo 1 > /sys/bus/pci/rescan 2>&1 || echo "Cannot rescan PCIe bus"
  when: "'link down' in pcie_link_status.stdout"
  ignore_errors: true

- name: Check for NVME after rescan
  ansible.builtin.shell: |
    sleep 2
    lsblk | grep nvme || echo "No NVME in lsblk"
  register: nvme_after_rescan
  changed_when: false
  failed_when: false
  when: "'link down' in pcie_link_status.stdout"

- name: Display NVME status after rescan
  ansible.builtin.debug:
    msg: "{{ nvme_after_rescan.stdout_lines }}"
  when: "'link down' in pcie_link_status.stdout"

- name: Check if M.2 HAT needs configuration
  ansible.builtin.shell: |
    # Check for M.2 HAT specific configuration
    ls -la /sys/class/gpio/ 2>/dev/null | head -5 || echo "No GPIO info"
    vcgencmd get_config int | grep -i pcie || echo "No PCIe config"
  register: hat_config
  changed_when: false
  failed_when: false
  ignore_errors: true

- name: Display M.2 HAT configuration info
  ansible.builtin.debug:
    msg: "{{ hat_config.stdout_lines }}"
  when: hat_config.rc == 0

