---
- name: Install zsh
  ansible.builtin.apt:
    name: zsh
    state: present

- name: Create michael user
  ansible.builtin.user:
    name: michael
    shell: /bin/bash
    create_home: true
    groups: sudo
    append: true

- name: Configure passwordless sudo for michael
  ansible.builtin.lineinfile:
    path: /etc/sudoers.d/michael
    line: "michael ALL=(ALL) NOPASSWD:ALL"
    mode: "0440"
    validate: "visudo -cf %s"
    create: true

- name: Configure passwordless sudo for packer user
  ansible.builtin.lineinfile:
    path: /etc/sudoers.d/packer
    line: "packer ALL=(ALL) NOPASSWD:ALL"
    mode: "0440"
    validate: "visudo -cf %s"
    create: true

- name: Find SSH public keys on control node
  ansible.builtin.find:
    paths: "{{ lookup('env', 'HOME') }}/.ssh"
    patterns:
      - "vm-access-key.pub"
      - "id_ed25519.pub"
      - "id_rsa.pub"
    file_type: file
  register: ssh_key_files
  delegate_to: localhost
  become: false
  run_once: true
  changed_when: false

- name: Read SSH public keys from control node
  ansible.builtin.slurp:
    src: "{{ item.path }}"
  register: ssh_key_contents
  delegate_to: localhost
  become: false
  loop: "{{ ssh_key_files.files }}"
  when: ssh_key_files.files | length > 0

- name: Create .ssh directory for michael
  ansible.builtin.file:
    path: /home/michael/.ssh
    state: directory
    owner: michael
    group: michael
    mode: "0700"
  when: ssh_key_contents.results is defined and ssh_key_contents.results | length > 0

- name: Add SSH public keys for michael
  ansible.builtin.authorized_key:
    user: michael
    key: "{{ item.content | b64decode | trim }}"
    state: present
    exclusive: false
  loop: "{{ ssh_key_contents.results }}"
  when: ssh_key_contents.results is defined and ssh_key_contents.results | length > 0

- name: Create .ssh directory for packer user
  ansible.builtin.file:
    path: /home/packer/.ssh
    state: directory
    owner: packer
    group: packer
    mode: "0700"
  when: ssh_key_contents.results is defined and ssh_key_contents.results | length > 0

- name: Add SSH public keys for packer user
  ansible.builtin.authorized_key:
    user: packer
    key: "{{ item.content | b64decode | trim }}"
    state: present
    exclusive: false
  loop: "{{ ssh_key_contents.results }}"
  when: ssh_key_contents.results is defined and ssh_key_contents.results | length > 0

- name: Warn if no SSH keys were found
  ansible.builtin.debug:
    msg: |
      WARNING: No SSH public keys found in ~/.ssh/
      Looked for: vm-access-key.pub, id_ed25519.pub, id_rsa.pub
      Password authentication will remain enabled. This is less secure.
      To fix: Copy your SSH public key to ~/.ssh/vm-access-key.pub or rebuild the image.
  when: ssh_key_contents.results is not defined or ssh_key_contents.results | length == 0

- name: Set default shell to bash (with zsh available)
  ansible.builtin.user:
    name: michael
    shell: /bin/bash
  # Note: zsh is installed and available, but bash remains the default shell
