---
- name: Clean audit logs
  ansible.builtin.file:
    path: "{{ item }}"
    state: absent
  loop:
    - /var/log/audit/audit.log
    - /var/log/auth.log
    - /var/log/btmp
    - /var/log/dpkg.log
    - /var/log/faillog
    - /var/log/kern.log
    - /var/log/lastlog
    - /var/log/syslog
    - /var/log/wtmp
  ignore_errors: true

- name: Clean persistent udev rules
  ansible.builtin.file:
    path: /etc/udev/rules.d/70-persistent-net.rules
    state: absent
  ignore_errors: true

- name: Find temporary directories
  ansible.builtin.find:
    paths:
      - /tmp
      - /var/tmp
    file_type: any
  register: find_tmp_directories

- name: Clean temporary directories
  ansible.builtin.file:
    path: "{{ item.path }}"
    state: absent
  loop: "{{ find_tmp_directories.files }}"
  loop_control:
    label: "{{ item.path }}"
  ignore_errors: true

- name: Find SSH host keys
  ansible.builtin.find:
    paths: /etc/ssh
    patterns: "ssh_host_*"
  register: find_ssh_host_keys

- name: Clean SSH host keys
  ansible.builtin.file:
    path: "{{ item.path }}"
    state: absent
  loop: "{{ find_ssh_host_keys.files }}"
  loop_control:
    label: "{{ item.path }}"
  ignore_errors: true

- name: Create script to regenerate SSH host keys on first boot
  ansible.builtin.copy:
    dest: /etc/rc.local
    content: |
      #!/bin/bash
      # Regenerate SSH host keys if they don't exist
      if [ ! -f /etc/ssh/ssh_host_rsa_key ] || [ ! -f /etc/ssh/ssh_host_ed25519_key ]; then
          /usr/bin/ssh-keygen -A
          systemctl restart ssh 2>/dev/null || true
      fi
      # Remove this script after first run
      rm -f /etc/rc.local
      exit 0
    mode: "0755"

- name: Clean machine-id
  block:
    - name: Empty /etc/machine-id
      community.general.filesize:
        path: /etc/machine-id
        size: 0

    - name: Remove /var/lib/dbus/machine-id
      ansible.builtin.file:
        path: /var/lib/dbus/machine-id
        state: absent

    - name: Create symbolic link to /etc/machine-id
      ansible.builtin.file:
        src: /etc/machine-id
        dest: /var/lib/dbus/machine-id
        state: link

- name: Clean shell history
  ansible.builtin.file:
    path: "{{ ansible_env.HOME }}/.bash_history"
    state: absent
  ignore_errors: true

- name: Clean apt cache
  ansible.builtin.apt:
    autoclean: true
    autoremove: true

- name: Update package lists for final cleanup
  ansible.builtin.apt:
    update_cache: true
